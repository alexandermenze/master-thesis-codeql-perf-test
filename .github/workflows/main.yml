name: Monitor CodeQL Query Performance

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'GitHub repo to analyze (owner/repo)'
        required: true
        default: 'octocat/Hello-World'
      ref:
        description: 'Branch, Tag or SHA to checkout'
        required: false
        default: 'main'

jobs:
  monitor:
    runs-on: ubuntu-latest
    env:
      REPO_INPUT: ${{ github.event.inputs.repository }}
    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Checkout external repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.repository }}
          ref: ${{ github.event.inputs.ref }}
          path: target-repo
          fetch-depth: 1

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      - name: Set up Python & install psrecord
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - run: |
          python -m pip install --upgrade pip
          pip install psrecord

      - name: Initialize CodeQL CLI
        id: init-codeql
        uses: github/codeql-action/init@v3
        with:
          languages: csharp

      - name: Add CodeQL to PATH using init output
        run: |
          CODEQL_BIN_PATH=${{ steps.init-codeql.outputs.codeql-path }}
          CODEQL_DIR=$(dirname "$CODEQL_BIN_PATH")
          echo "Adding CodeQL directory to PATH: $CODEQL_DIR"
          echo "$CODEQL_DIR" >> $GITHUB_PATH

      - name: Prepare repository name
        run: |
          echo "REPO_NAME=${REPO_INPUT//\//-}" >> $GITHUB_ENV

      - name: Run CodeQL script under psrecord
        run: |
          SCRIPT=./run-analysis.sh
          QUERY_FILE="identify-call-paths.ql"
          LOG_FILE="${REPO_NAME}.psrecord.log"
          OUTPUT_FILE="${REPO_NAME}.output.log"

          chmod +x $SCRIPT

          psrecord "$SCRIPT -s target-repo -d db -q identify-call-paths.ql" \
            --include-children \
            --log "$LOG_FILE" \
            2>&1 | tee $OUTPUT_FILE

      - name: Upload resource usage log
        uses: actions/upload-artifact@v4
        with:
          name: psrecord-log-${{ env.REPO_NAME }}
          path: ${{ env.REPO_NAME }}.psrecord.log

      - name: Upload script output log
        uses: actions/upload-artifact@v4
        with:
          name: codeql-output-${{ env.REPO_NAME }}
          path: ${{ env.REPO_NAME }}.output.log

